name: Trigger Issue Processing

on:
  issues:
    types: [opened]

jobs:
  trigger-processing:
    runs-on: ubuntu-latest

    steps:
      - name: Extract issue inputs
        id: extract
        run: |
          BODY="${{ github.event.issue.body }}"
          TITLE="${{ github.event.issue.title }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"

          # Save body to file for multiline handling
          echo "$BODY" > issue_body.txt

          # Extract fields from issue body - matching the actual template field labels
          agent_name=$(echo "$BODY" | grep -A 2 "### Agent Name" | tail -n 1 | xargs)
          image=$(echo "$BODY" | grep -A 2 "### Image" | tail -n 1 | xargs)
          model=$(echo "$BODY" | grep -A 2 "### Model" | tail -n 1 | xargs)
          test_type=$(echo "$BODY" | grep -A 2 "### Test Type" | tail -n 1 | xargs)
          tool_call_eval=$(echo "$BODY" | grep -A 2 "### Tool Call Evaluation" | tail -n 1 | xargs)

          if [[ -z "$agent_name" || -z "$test_type" ]]; then
            echo "âŒ Missing required inputs"
            exit 1
          fi

          echo "agent_name=$agent_name" >> $GITHUB_OUTPUT
          echo "image=$image" >> $GITHUB_OUTPUT
          echo "model=$model" >> $GITHUB_OUTPUT
          echo "test_type=$test_type" >> $GITHUB_OUTPUT
          echo "tool_call_eval=$tool_call_eval" >> $GITHUB_OUTPUT
          echo "issue_title=$TITLE" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "repo_owner=$REPO_OWNER" >> $GITHUB_OUTPUT
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
          
          # Store body in multiline format
          echo "issue_body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Trigger Triggering_Github_Actions workflow
        env:
          ISSUE_BODY: ${{ steps.extract.outputs.issue_body }}
        run: |
          # Create JSON payload with proper escaping
          payload=$(jq -n \
            --arg event_type "process_issue" \
            --arg issue_title "${{ steps.extract.outputs.issue_title }}" \
            --arg issue_body "$ISSUE_BODY" \
            --arg issue_number "${{ steps.extract.outputs.issue_number }}" \
            --arg agent_name "${{ steps.extract.outputs.agent_name }}" \
            --arg image "${{ steps.extract.outputs.image }}" \
            --arg model "${{ steps.extract.outputs.model }}" \
            --arg test_type "${{ steps.extract.outputs.test_type }}" \
            --arg tool_call_eval "${{ steps.extract.outputs.tool_call_eval }}" \
            --arg source_repo_owner "${{ steps.extract.outputs.repo_owner }}" \
            --arg source_repo_name "${{ steps.extract.outputs.repo_name }}" \
            '{
              event_type: $event_type,
              client_payload: {
                issue_title: $issue_title,
                issue_body: $issue_body,
                issue_number: $issue_number,
                agent_name: $agent_name,
                image: $image,
                model: $model,
                test_type: $test_type,
                tool_call_eval: $tool_call_eval,
                source_repo_owner: $source_repo_owner,
                source_repo_name: $source_repo_name
              }
            }')
          
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.DISPATCH_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${{ github.repository_owner }}/Triggering_Githut_Actions/dispatches \
            -d "$payload"

      - name: Post acknowledgment comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš€ **Processing Started**\n\nYour issue has been received and is being processed. The results will be posted here shortly.'
            })